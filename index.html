<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidated Panchang Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for a clean look, as per theme.txt -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Body font from theme.txt */
            /* Applying celestial-gradient from theme.txt */
            background: linear-gradient(135deg, #fcd34d, #ef4444, #fef3c7);
            color: #1f2937; /* Text color from theme.txt card */
            min-height: 100vh; /* Ensure full height for gradient */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem; /* Add some padding around the main content */
        }
        h1, h2, h3 {
            font-family: 'Inter', sans-serif; /* Headings also Inter, as per theme.txt */
        }
        .loader {
            border: 4px solid #f3f3f3; /* from theme.txt */
            border-top: 4px solid #dc2626; /* from theme.txt */
            border-radius: 50%;
            width: 40px; /* from theme.txt */
            height: 40px; /* from theme.txt */
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Card styling from theme.txt */
        .card {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(209, 213, 219, 0.5);
            color: #1f2937;
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* shadow-2xl */
        }

        /* Custom table styling for better visual appeal */
        .panchang-table {
            border-collapse: collapse;
            width: 100%;
        }
        .panchang-table th, .panchang-table td {
            padding: 0.4rem 0.6rem; /* Reduced padding */
            border-bottom: 1px solid #d1d5db; /* Neutral gray border */
            text-align: left;
            font-size: 0.875rem; /* text-sm for increased font size */
            /* white-space: nowrap; /* Removed to allow text wrapping */
        }
        .panchang-table th {
            background-color: #e5e7eb; /* Light gray header background */
            font-weight: 600;
            color: #4b5563; /* Darker gray text */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .panchang-table tbody tr:nth-child(odd) {
            background-color: #ffffff; /* White background for odd rows */
        }
        .panchang-table tbody tr:nth-child(even) {
            background-color: #f9fafb; /* Very light gray for even rows */
        }
        .panchang-table tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.05); /* Hover from theme.txt */
        }
        /* Input, Select styling from theme.txt */
        select, input[type="date"], input[type="text"] {
            color: #1f2937;
            background-color: #ffffff;
            border-color: #d1d5db;
        }
        select option { background-color: #ffffff; color: #1f2937; }

        /* Button styling from theme.txt */
        .btn-primary {
            background-color: #dc2626; /* Red-600 from theme.txt */
            color: white;
            font-weight: bold;
            padding: 0.75rem 1rem; /* py-3 px-4 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
        }
        .btn-primary:hover {
            background-color: #b91c1c; /* Red-700 from theme.txt */
            transform: scale(1.05); /* hover:scale-105 */
        }

        /* Styling for the expandable arrow */
        .expand-arrow {
            display: inline-block;
            transition: transform 0.2s ease-in-out;
        }
        .expand-arrow.expanded {
            transform: rotate(90deg);
        }
        .detail-row-content {
            padding: 1rem;
            background-color: #f0f4f8; /* Light blue-gray for detail background */
            border-top: 1px solid #e2e8f0;
            color: #4a5568;
            font-size: 0.875rem; /* text-sm */
        }
        .detail-row-content p {
            margin-bottom: 0.5rem;
        }
        .detail-row-content p:last-child {
            margin-bottom: 0;
        }

        /* Autocomplete suggestions styling */
        #suggestions-list {
            position: absolute;
            z-index: 20;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            width: calc(100% - 2rem); /* Adjust to match input width */
            margin-top: 0.25rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #suggestions-list div {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
        }
        #suggestions-list div:last-child {
            border-bottom: none;
        }
        #suggestions-list div:hover {
            background-color: #f3f4f6;
        }
        #suggestions-loader {
            display: none;
            margin-top: 0.5rem;
            margin-left: 0.5rem;
        }
        .small-loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db; /* Blue for suggestion loader */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Main content card with theme.txt styling -->
        <div class="w-full max-w-6xl mx-auto card p-6 sm:p-8 md:p-10">
            <header class="text-center mb-8 md:mb-10">
                <h1 class="text-3xl md:text-4xl font-bold tracking-tight text-gray-800 mb-2 leading-tight">
                    <span class="mr-3 text-yellow-600 text-4xl">&#x2643;</span> Divine Panchang Insights <span class="ml-3 text-gray-700 text-4xl">&#x2644;</span>
                </h1>
                <p class="text-gray-700 text-lg sm:text-xl mt-2">Unveiling daily Vedic wisdom for auspicious beginnings.</p>
            </header>

            <!-- Form Section -->
            <form id="panchangForm" class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end bg-gray-50 p-6 sm:p-8 rounded-xl shadow-inner border border-gray-200">
                <div>
                    <label for="startDate" class="block text-base font-semibold text-gray-700 mb-1">Start Date</label>
                    <input type="date" id="startDate" name="startDate" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" required>
                </div>
                <div>
                    <label for="endDate" class="block text-base font-semibold text-gray-700 mb-1">End Date</label>
                    <input type="date" id="endDate" name="endDate" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" required>
                </div>
                <div class="relative"> <!-- Added relative positioning for suggestions list -->
                    <label for="location" class="block text-base font-semibold text-gray-700 mb-1">Location</label>
                    <input type="text" id="location" name="location" placeholder="Detecting location..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" required autocomplete="off">
                    <div id="suggestions-loader" class="absolute right-3 top-1/2 -translate-y-1/2 hidden">
                        <div class="small-loader"></div>
                    </div>
                    <div id="suggestions-list" class="hidden"></div> <!-- Suggestions will appear here -->
                </div>
                <div class="md:col-span-3 text-center mt-4">
                    <button type="submit" class="w-full md:w-auto px-12 py-3 rounded-lg btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Get Panchang
                    </button>
                </div>
            </form>

            <!-- Results Section -->
            <div id="results" class="mt-10">
                <div id="loader" class="hidden justify-center items-center py-10">
                    <div class="loader"></div>
                </div>
                <div id="error-message" class="hidden text-center p-4 bg-red-100 text-red-700 rounded-lg border border-red-300 shadow-sm"></div>
                <div id="panchang-data" class="mt-6">
                    <!-- Dynamic consolidated table will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const panchangForm = document.getElementById('panchangForm');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const panchangDataContainer = document.getElementById('panchang-data');
        const locationInput = document.getElementById('location');
        const suggestionsList = document.getElementById('suggestions-list');
        const suggestionsLoader = document.getElementById('suggestions-loader');

        // --- Global Variables ---
        let debounceTimer;

        // --- Event Listeners ---
        panchangForm.addEventListener('submit', handleFormSubmit);
        panchangDataContainer.addEventListener('click', handleExpandClick);
        locationInput.addEventListener('input', handleLocationInput);
        suggestionsList.addEventListener('click', handleSuggestionClick);
        document.addEventListener('click', handleDocumentClick); // To hide suggestions when clicking outside
        document.addEventListener('DOMContentLoaded', initializeLocation); // Autodetect location on load

        /**
         * Initializes location detection on page load.
         */
        function initializeLocation() {
            if (navigator.geolocation) {
                locationInput.placeholder = "Detecting location...";
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        console.log(`Geolocation successful: Lat ${lat}, Lng ${lng}`);
                        try {
                            // Use GeoNames reverse geocoding API to get city/state from coordinates
                            // NOTE: This assumes your backend has a /reverse_geocode endpoint or similar
                            // For now, we'll use the /suggest_locations endpoint with a query based on coordinates
                            // A more robust solution would be a dedicated reverse geocoding endpoint in app.py
                            const reverseGeocodeUrl = `http://api.geonames.org/findNearestAddressJSON?lat=${lat}&lng=${lng}&username=YOUR_GEONAMES_USERNAME`; // Replace with your username
                            const response = await fetch(reverseGeocodeUrl);
                            const data = await response.json();

                            let detectedLocation = "Unknown Location";
                            if (data && data.address && data.address.street) {
                                // GeoNames findNearestAddressJSON returns street and postal code, not always city/state directly
                                // A better endpoint for city/state would be findNearestPlaceNameJSON
                                const placeNameUrl = `http://api.geonames.org/findNearestPlaceNameJSON?lat=${lat}&lng=${lng}&username=YOUR_GEONAMES_USERNAME`; // Replace with your username
                                const placeResponse = await fetch(placeNameUrl);
                                const placeData = await placeResponse.json();

                                if (placeData && placeData.geonames && placeData.geonames.length > 0) {
                                    const place = placeData.geonames[0];
                                    detectedLocation = place.name;
                                    if (place.adminName1 && place.adminName1.toLowerCase() !== place.name.toLowerCase()) {
                                        detectedLocation += `, ${place.adminName1}`;
                                    }
                                    if (place.countryName && place.countryName.toLowerCase() !== place.name.toLowerCase() && place.countryName.toLowerCase() !== place.adminName1.toLowerCase()) {
                                        detectedLocation += `, ${place.countryName}`;
                                    }
                                } else {
                                    console.warn("Could not find nearest place name for autodetected coordinates.");
                                    // Fallback to a more generic display if place name not found
                                    detectedLocation = `Lat: ${lat.toFixed(2)}, Lng: ${lng.toFixed(2)}`;
                                }
                            } else {
                                console.warn("Could not find address for autodetected coordinates.");
                                detectedLocation = `Lat: ${lat.toFixed(2)}, Lng: ${lng.toFixed(2)}`;
                            }
                            locationInput.value = detectedLocation;
                            locationInput.placeholder = "e.g., New York, NY or California"; // Revert placeholder
                        } catch (error) {
                            console.error('Error during reverse geocoding:', error);
                            locationInput.placeholder = "Enter state or city name (e.g., California)"; // Fallback placeholder
                        }
                    },
                    (error) => {
                        console.warn(`Geolocation error (${error.code}): ${error.message}`);
                        locationInput.placeholder = "Enter state or city name (e.g., California)"; // Fallback placeholder
                        showError("Location detection blocked or failed. Please enter your location manually.");
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                console.warn("Geolocation is not supported by this browser.");
                locationInput.placeholder = "Enter state or city name (e.g., California)"; // Fallback placeholder
            }
        }

        /**
         * Handles the main form submission to fetch Panchang data from the backend.
         */
        async function handleFormSubmit(e) {
            e.preventDefault();
            panchangDataContainer.innerHTML = '';
            errorMessage.classList.add('hidden');
            loader.style.display = 'flex';
            suggestionsList.classList.add('hidden'); // Hide suggestions on form submit

            const formData = new FormData(panchangForm);
            const startDate = formData.get('startDate');
            const endDate = formData.get('endDate');
            const location = formData.get('location');
            
            if (!startDate || !endDate || !location) {
                showError("Please fill in all fields: Start Date, End Date, and Location.");
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showError("Start date cannot be after end date.");
                return;
            }

            try {
                // NOTE: Ensure your Flask server is running on http://127.0.0.1:5000
                const apiUrl = `https://panchang-api-git-main-ajay-aggarwals-projects-768dac43.vercel.app/panchang?start_date=${startDate}&end_date=${endDate}&location=${encodeURIComponent(location)}`;
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.error) {
                    showError(data.error);
                } else {
                    displayPanchangData(data.panchang);
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                showError('Failed to connect to the backend server or an API error occurred. Please ensure the Python server is running and your GeoNames username is correctly configured in app.py.');
            } finally {
                loader.style.display = 'none';
            }
        }

        /**
         * Handles clicks on the expand/collapse arrow buttons.
         */
        function handleExpandClick(e) {
            const button = e.target.closest('.expand-btn');
            if (!button) return;

            const date = button.dataset.date;
            const detailRow = document.getElementById(`details-${date}`);
            const arrowSpan = button.querySelector('.expand-arrow');

            if (detailRow) {
                detailRow.classList.toggle('hidden');
                arrowSpan.classList.toggle('expanded');
            }
        }

        /**
         * Handles input in the location field for suggestions.
         */
        function handleLocationInput() {
            clearTimeout(debounceTimer);
            const query = locationInput.value.trim();

            if (query.length < 3) { // Only fetch suggestions for queries of 3 or more characters
                suggestionsList.classList.add('hidden');
                suggestionsLoader.style.display = 'none';
                return;
            }

            suggestionsLoader.style.display = 'inline-block';
            suggestionsList.innerHTML = ''; // Clear previous suggestions
            suggestionsList.classList.add('hidden');

            debounceTimer = setTimeout(async () => {
                try {
                    const apiUrl = `http://127.0.0.1:5000/suggest_locations?query=${encodeURIComponent(query)}`;
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (data.error) {
                        console.error('Error fetching suggestions:', data.error);
                        suggestionsList.classList.add('hidden');
                    } else {
                        renderSuggestions(data.suggestions);
                    }
                } catch (error) {
                    console.error('Error fetching suggestions:', error);
                    suggestionsList.classList.add('hidden');
                } finally {
                    suggestionsLoader.style.display = 'none';
                }
            }, 300); // Debounce to prevent too many requests
        }

        /**
         * Renders the fetched location suggestions in the suggestions list.
         * @param {Array} suggestions - An array of suggestion objects {name: string, geonameId: string}.
         */
        function renderSuggestions(suggestions) {
            suggestionsList.innerHTML = '';
            if (suggestions && suggestions.length > 0) {
                suggestions.forEach(suggestion => {
                    const div = document.createElement('div');
                    div.textContent = suggestion.name;
                    div.dataset.geonameId = suggestion.geonameId; // Store geonameId if needed later
                    div.dataset.locationName = suggestion.name; // Store full name
                    suggestionsList.appendChild(div);
                });
                suggestionsList.classList.remove('hidden');
            } else {
                suggestionsList.classList.add('hidden');
            }
        }

        /**
         * Handles click on a suggestion item.
         * @param {Event} e - The click event.
         */
        function handleSuggestionClick(e) {
            const selectedSuggestion = e.target.closest('div');
            if (selectedSuggestion && selectedSuggestion.dataset.locationName) {
                locationInput.value = selectedSuggestion.dataset.locationName;
                suggestionsList.classList.add('hidden');
            }
        }

        /**
         * Hides suggestions list when clicking anywhere else on the document.
         * @param {Event} e - The click event.
         */
        function handleDocumentClick(e) {
            if (!locationInput.contains(e.target) && !suggestionsList.contains(e.target)) {
                suggestionsList.classList.add('hidden');
            }
        }
        
        /**
         * Displays the fetched panchang data on the page in a single consolidated tabular format.
         */
        function displayPanchangData(panchangList) {
            if (!panchangList || panchangList.length === 0) {
                panchangDataContainer.innerHTML = `<p class="text-center text-gray-500 py-8">No data found for the selected dates.</p>`;
                return;
            }

            // Define the order of columns for the main visible row
            const mainColumns = [
                { key: 'date', name: 'Date', class: 'w-[10%]' }, 
                { key: 'weekday', name: 'Day', class: 'w-[7%]' }, /* Reduced width for weekday */
                { key: 'tithi', name: 'Tithi', class: 'w-[12%]' },
                { key: 'paksha', name: 'Paksha', class: 'w-[10%]' },
                { key: 'yoga', name: 'Yoga', class: 'w-[12%]' },
                { key: 'karana', name: 'Karana', class: 'w-[12%]' },
                { key: 'moonsign', name: 'Moonsign', class: 'w-[10%]' },
                { key: 'nakshatra', name: 'Nakshatra', class: 'w-[12%]' },
                { key: 'rahu_kalam', name: 'Rahu Kaal', class: 'text-red-600 font-semibold w-[12%]' }, 
                { key: 'abhijit_muhurta', name: 'Abhijit Muhurta', class: 'w-[12%]' }
            ];

            // Define the columns for the expandable detail row
            const detailColumns = [
                { key: 'sunrise', name: 'Sunrise' },
                { key: 'sunset', name: 'Sunset' },
                { key: 'brahma_muhurta', name: 'Brahma Muhurta' },
                { key: 'amrit_kalam', name: 'Amrit Kaal' }
            ];

            // Generate table headers for the main columns + Details column
            const tableHeaders = mainColumns.map(col => `<th class="px-4 py-2 ${col.class || ''}">${col.name}</th>`).join('') + 
                                 `<th class="px-4 py-2 w-[5%]"></th>`; // Header for the expand button, fixed width, no text

            // Helper to format values (handles arrays by joining with <br>)
            const formatValue = (value) => {
                if (Array.isArray(value)) {
                    return value.join('<br>'); 
                }
                return value || 'N/A';
            };

            // Generate table rows for each day
            const allTableRows = panchangList.map(item => {
                if (item.error) {
                    // If a day has an error, display it as a single row spanning all columns
                    return `
                        <tr class="bg-red-50 text-red-700">
                            <td colspan="${mainColumns.length + 1}" class="px-4 py-2 text-center font-semibold">
                                ${new Date(item.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}: ${item.error}
                            </td>
                        </tr>
                    `;
                }

                // Main row content
                const mainRowCells = mainColumns.map(col => {
                    const value = item[col.key];
                    const cellClass = col.class ? col.class : ''; // Apply specific class if defined
                    return `<td class="px-4 py-2 ${cellClass}">${formatValue(value)}</td>`;
                }).join('');

                // Expand button cell
                const expandButtonCell = `
                    <td class="px-4 py-2 text-center w-[5%]">
                        <button class="expand-btn text-gray-600 hover:text-gray-900 focus:outline-none" data-date="${item.date}">
                            <span class="expand-arrow">&#9658;</span>
                        </button>
                    </td>
                `;

                // Detail row content
                const detailRowContent = detailColumns.map(col => 
                    `<p class="text-sm"><strong>${col.name}:</strong> ${formatValue(item[col.key])}</p>`
                ).join('');

                return `
                    <tr class="main-row">
                        ${mainRowCells}
                        ${expandButtonCell}
                    </tr>
                    <tr id="details-${item.date}" class="detail-row hidden">
                        <td colspan="${mainColumns.length + 1}">
                            <div class="detail-row-content">
                                ${detailRowContent}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Assemble the complete table HTML
            const tableHtml = `
                <div class="overflow-x-auto rounded-lg shadow-lg border border-gray-200">
                    <table class="min-w-full panchang-table">
                        <thead>
                            <tr>
                                ${tableHeaders}
                            </tr>
                        </thead>
                        <tbody>
                            ${allTableRows}
                        </tbody>
                    </table>
                </div>
            `;
            panchangDataContainer.innerHTML = tableHtml;
        }

        /**
         * Displays an error message in the UI.
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            loader.style.display = 'none';
        }
    </script>
</body>
</html>
